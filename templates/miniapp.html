<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è –ë–æ—Ç | –ö—Ä–∏–ø—Ç–æ –ê—Ä–±–∏—Ç—Ä–∞–∂</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* ==================== –°—Ç–∏–ª–∏ CSS ==================== */
        :root {
            --bg-color: #1a1a1a;
            --card-bg-color: #242526;
            --text-color: #f0f0f0;
            --secondary-text-color: #888;
            --green-color: #4CAF50;
            --red-color: #F44336;
            --purple-color: #9C27B0;
            --entry-color: #FFC107;
            --chart-line-color: #06b6d4;
            --chart-grid-color: rgba(136, 136, 136, 0.2);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            padding-bottom: 70px; /* –ú–µ—Å—Ç–æ –¥–ª—è –Ω–∏–∂–Ω–µ–≥–æ –º–µ–Ω—é */
        }

        .header {
            background-color: var(--card-bg-color);
            padding: 15px 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #333;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            font-size: 18px;
            margin: 0;
            font-weight: 500;
        }

        .header-actions button {
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 24px;
            cursor: pointer;
        }

        /* ==================== –ö–∞—Ä—Ç–æ—á–∫–∏ —Å–∏–≥–Ω–∞–ª–æ–≤ ==================== */
        .container {
            padding: 10px;
        }

        .coin-group {
            background-color: var(--card-bg-color);
            border-radius: 12px;
            margin-bottom: 15px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            padding: 10px;
        }

        .coin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 10px;
            border-bottom: 1px solid #333;
            margin-bottom: 10px;
        }

        .coin-header .name {
            font-size: 16px;
            font-weight: bold;
        }

        .spread-summary {
            font-size: 14px;
            line-height: 1.6;
        }

        .spread-summary span {
            display: inline-block;
            min-width: 60px;
            text-align: right;
            font-weight: 600;
        }

        .green { color: var(--green-color); }
        .red { color: var(--red-color); }
        .yellow { color: var(--entry-color); }

        .exchange-pair {
            display: flex;
            margin-top: 10px;
            gap: 10px;
        }

        .exchange-card {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            background-color: #333;
            font-size: 12px;
            line-height: 1.5;
        }

        .exchange-card.long { border: 1px solid var(--green-color); }
        .exchange-card.short { border: 1px solid var(--red-color); }

        .exchange-name { font-weight: bold; margin-bottom: 5px; }

        /* ==================== –ù–∏–∂–Ω–µ–µ –º–µ–Ω—é ==================== */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            background-color: var(--card-bg-color);
            border-top: 1px solid #333;
            z-index: 200;
        }

        .nav-item {
            flex: 1;
            text-align: center;
            padding: 10px 0;
            color: var(--secondary-text-color);
            cursor: pointer;
            font-size: 12px;
        }

        .nav-item.active {
            color: var(--purple-color);
            font-weight: bold;
        }

        .nav-item i {
            display: block;
            font-size: 20px;
            margin-bottom: 2px;
        }

        /* ==================== –°—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ ==================== */
        .settings-section h3 {
            border-bottom: 1px solid #333;
            padding-bottom: 5px;
            margin-top: 20px;
            font-size: 16px;
        }

        .settings-section label {
            display: block;
            margin-top: 10px;
            font-size: 14px;
        }

        .settings-section input[type="text"],
        .settings-section input[type="number"],
        .settings-section textarea {
            width: 95%;
            padding: 10px;
            margin-top: 5px;
            border: 1px solid #555;
            border-radius: 4px;
            background-color: #333;
            color: var(--text-color);
            font-size: 14px;
        }

        .settings-section .checkbox-group {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .settings-section .checkbox-group label {
            display: flex;
            align-items: center;
            margin: 0;
        }

        .settings-section .checkbox-group input[type="checkbox"] {
            margin-right: 5px;
        }

        .save-button {
            background-color: #06b6d4;
            color: white;
            padding: 15px;
            border: none;
            border-radius: 8px;
            width: 100%;
            font-size: 16px;
            font-weight: bold;
            margin-top: 20px;
            cursor: pointer;
        }

    </style>
</head>
<body>

    <div class="header">
        <h1>–ö–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—è –ë–æ—Ç | –ö—Ä–∏–ø—Ç–æ –ê—Ä–±–∏—Ç—Ä–∞–∂</h1>
        <div class="header-actions">
            <button id="refresh-button">üîÑ</button>
        </div>
    </div>

    <div class="container">
        <div id="screen-trade" class="screen" style="display: block;">
            <div id="loading-state">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
            <div id="spread-list">
                </div>
        </div>

        <div id="screen-settings" class="screen" style="display: none;">
            <form id="settings-form">

                <div class="settings-section">
                    <h3>–ë–∏—Ä–∂–∏</h3>
                    <p class="secondary-text-color">–í—ã–±–µ—Ä–∏—Ç–µ –±–∏—Ä–∂–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Å–≤—è–∑–æ–∫.</p>
                    <div id="exchange-checkboxes" class="checkbox-group">
                        </div>
                </div>

                <div class="settings-section">
                    <h3>–ß–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫</h3>
                    <label>–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏—è –º–æ–Ω–µ—Ç —Ä–∞–∑–¥–µ–ª—è—è –ø—Ä–æ–±–µ–ª–æ–º (BTC ETH SOL):</label>
                    <textarea id="blacklist-input" rows="3"></textarea>
                </div>

                <div class="settings-section">
                    <h3>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h3>

                    <h4>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –∫—É—Ä—Å–æ–≤—ã—Ö —Å–ø—Ä–µ–¥–∞—Ö</h4>
                    <label>
                        <input type="checkbox" id="spread-notify-enabled" checked> –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –∫—É—Ä—Å–æ–≤—ã—Ö —Å–ø—Ä–µ–¥–∞—Ö
                    </label>

                    <label>–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∫—É—Ä—Å–æ–≤–æ–π —Å–ø—Ä–µ–¥ (%):</label>
                    <input type="number" id="min-spread-input" min="0.1" step="0.1">

                    <label>–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —á–∞—Å—Ç–æ—Ç–∞ (–º–∏–Ω):</label>
                    <input type="number" id="spread-frequency-input" value="120" min="5" step="5">

                    <h4>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Å–ø—Ä–µ–¥–∞—Ö —Ñ–∞–Ω–¥–∏–Ω–≥–∞</h4>
                    <label>
                        <input type="checkbox" id="funding-notify-enabled"> –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Å–ø—Ä–µ–¥–∞—Ö —Ñ–∞–Ω–¥–∏–Ω–≥–∞
                    </label>

                    <label>–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Å–ø—Ä–µ–¥ —Ñ–∞–Ω–¥–∏–Ω–≥–∞ (%):</label>
                    <input type="number" id="min-funding-spread-input" min="0.1" step="0.1">

                    <label>–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —á–∞—Å—Ç–æ—Ç–∞ (–º–∏–Ω):</label>
                    <input type="number" id="funding-frequency-input" value="120" min="5" step="5">
                </div>

                <button type="submit" class="save-button">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </form>
        </div>

        <div id="screen-info" class="screen" style="display: none;">
            <h3>–ò—Å—Ç–æ—Ä–∏—è —Å–ø—Ä–µ–¥–æ–≤</h3>
            <p>–≠—Ç–æ—Ç —Ä–∞–∑–¥–µ–ª –±—É–¥–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –≥—Ä–∞—Ñ–∏–∫ –∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é.</p>
            <canvas id="spread-chart" width="400" height="200"></canvas>
        </div>
    </div>

    <div class="bottom-nav">
        <div class="nav-item active" data-screen="trade">
            <i>‚öôÔ∏è</i>–¢–æ—Ä–≥–æ–≤–ª—è
        </div>
        <div class="nav-item" data-screen="settings">
            <i>üéõÔ∏è</i>–ù–∞—Å—Ç—Ä–æ–π–∫–∏
        </div>
        <div class="nav-item" data-screen="info">
            <i>‚ÑπÔ∏è</i>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
        </div>
    </div>


    <script>
        const tg = window.Telegram.WebApp;
        const screens = {
            trade: document.getElementById('screen-trade'),
            settings: document.getElementById('screen-settings'),
            info: document.getElementById('screen-info')
        };
        const navItems = document.querySelectorAll('.nav-item');
        let userId = null;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Web App
        tg.ready();

        // –ü–æ–ª—É—á–∞–µ–º user_id –∏–∑ URL (–ø–µ—Ä–µ–¥–∞–Ω–æ –∏–∑ cmd_start)
        const urlParams = new URLSearchParams(window.location.search);
        userId = urlParams.get('user_id');


        // ==================== –§—É–Ω–∫—Ü–∏–∏ UI –∏ –ù–∞–≤–∏–≥–∞—Ü–∏–∏ ====================
        function showScreen(screenId) {
            // –°–∫—Ä—ã—Ç—å –≤—Å–µ —ç–∫—Ä–∞–Ω—ã –∏ —Å–Ω—è—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Å –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
            Object.values(screens).forEach(screen => screen.style.display = 'none');
            navItems.forEach(item => item.classList.remove('active'));

            // –ü–æ–∫–∞–∑–∞—Ç—å –Ω—É–∂–Ω—ã–π —ç–∫—Ä–∞–Ω –∏ –¥–æ–±–∞–≤–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å
            screens[screenId].style.display = 'block';
            document.querySelector(`.nav-item[data-screen="${screenId}"]`).classList.add('active');

            // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏
            if (screenId === 'trade') {
                loadSpreadData();
            } else if (screenId === 'settings') {
                loadSettings();
            }
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
        navItems.forEach(item => {
            item.addEventListener('click', () => {
                showScreen(item.dataset.screen);
            });
        });

        document.getElementById('refresh-button').addEventListener('click', () => {
             loadSpreadData(true);
        });


        // ==================== –§—É–Ω–∫—Ü–∏–∏ –ó–∞–≥—Ä—É–∑–∫–∏ –î–∞–Ω–Ω—ã—Ö ====================

        async function loadSpreadData(isRefresh = false) {
            if (!userId) {
                document.getElementById('spread-list').innerHTML = '<div style="color:red;padding:20px;">–û—à–∏–±–∫–∞: User ID –Ω–µ –Ω–∞–π–¥–µ–Ω.</div>';
                return;
            }

            const listElement = document.getElementById('spread-list');
            if (!isRefresh) {
                listElement.innerHTML = document.getElementById('loading-state').outerHTML;
            }

            try {
                const response = await fetch(`/api/get_arb_data?user_id=${userId}`);
                const data = await response.json();

                if (data.spreads && data.spreads.length > 0) {
                    renderSpreadList(data.spreads);
                } else {
                    listElement.innerHTML = '<div style="padding:20px;text-align:center;">–ê–∫—Ç—É–∞–ª—å–Ω—ã—Ö —Å–≤—è–∑–æ–∫ –ø–æ–∫–∞ –Ω–µ—Ç. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.</div>';
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–≤—è–∑–æ–∫:', error);
                listElement.innerHTML = '<div style="color:red;padding:20px;text-align:center;">–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É.</div>';
            }
        }

        function renderSpreadList(spreads) {
            const listElement = document.getElementById('spread-list');
            listElement.innerHTML = ''; // –û—á–∏—Å—Ç–∫–∞

            // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –º–æ–Ω–µ—Ç–µ –¥–ª—è UI, –∫–∞–∫ –Ω–∞ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞—Ö
            const groupedSpreads = spreads.reduce((acc, s) => {
                const coin = s.coin;
                if (!acc[coin]) {
                    acc[coin] = [];
                }
                acc[coin].push(s);
                return acc;
            }, {});

            for (const coin in groupedSpreads) {
                const group = document.createElement('div');
                group.className = 'coin-group';

                // –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞ –≥—Ä—É–ø–ø—ã
                const highestSpread = Math.max(...groupedSpreads[coin].map(s => s.net_spread));

                let html = `
                    <div class="coin-header">
                        <span class="name">üí∞ ${coin}</span>
                        <span>
                            –°–ø—Ä–µ–¥ –≤—Ö–æ–¥–∞: <span class="green">${highestSpread.toFixed(4)}%</span>
                        </span>
                    </div>
                `;

                // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–∞–∂–¥–æ–π —Å–≤—è–∑–∫–∏ –≤ –≥—Ä—É–ø–ø–µ
                groupedSpreads[coin].forEach(s => {
                    const statusColor = s.status.includes('üü¢') ? 'green' : 'yellow';

                    html += `
                        <div class="exchange-pair" onclick="showScreen('info', '${s.coin}')">
                            <div class="exchange-card long">
                                <div class="exchange-name">üìà LONG ${s.long_exchange}</div>
                                <div>Bid: <span class="green">${s.bid_long.toFixed(5)}</span></div>
                                <div>Ask: ${s.ask_short.toFixed(5)}</div>
                                <div>–§–∞–Ω–¥–∏–Ω–≥: <span class="${s.funding_long > 0 ? 'red' : 'green'}">${s.funding_long.toFixed(4)}%</span></div>
                            </div>
                            <div class="exchange-card short">
                                <div class="exchange-name">üìâ SHORT ${s.short_exchange}</div>
                                <div>Bid: ${s.bid_long.toFixed(5)}</div>
                                <div>Ask: <span class="red">${s.ask_short.toFixed(5)}</span></div>
                                <div>–§–∞–Ω–¥–∏–Ω–≥: <span class="${s.funding_short > 0 ? 'red' : 'green'}">${s.funding_short.toFixed(4)}%</span></div>
                            </div>
                        </div>
                        <div class="spread-summary" style="margin-top: 5px; font-size: 13px;">
                            –ß–∏—Å—Ç—ã–π —Å–ø—Ä–µ–¥: <span class="${statusColor}">${s.net_spread.toFixed(4)}%</span> |
                            –ì—Ä—É–±—ã–π —Å–ø—Ä–µ–¥: <span class="yellow">${s.gross_spread.toFixed(4)}%</span>
                        </div>
                    `;
                });

                group.innerHTML = html;
                listElement.appendChild(group);
            }
        }

        // ==================== –§—É–Ω–∫—Ü–∏–∏ –ù–∞—Å—Ç—Ä–æ–µ–∫ ====================

        async function loadSettings() {
            if (!userId) return;

            try {
                const response = await fetch(`/api/get_user_settings/${userId}`);
                const data = await response.json();
                const settings = data.settings;
                const supportedExchanges = data.supported_exchanges;

                // 1. –ë–∏—Ä–∂–∏
                const exContainer = document.getElementById('exchange-checkboxes');
                exContainer.innerHTML = '';
                supportedExchanges.forEach(ex => {
                    const isChecked = settings.exchanges.includes(ex.toUpperCase());
                    exContainer.innerHTML += `
                        <label>
                            <input type="checkbox" data-exchange="${ex.toUpperCase()}" ${isChecked ? 'checked' : ''}>
                            ${ex.toUpperCase()}
                        </label>
                    `;
                });

                // 2. –ß–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫
                document.getElementById('blacklist-input').value = settings.blacklist.join(' ');

                // 3. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
                document.getElementById('min-spread-input').value = settings.min_spread;
                document.getElementById('min-funding-spread-input').value = settings.min_funding_spread;

                // –ó–¥–µ—Å—å –Ω—É–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏—è —á–µ–∫–±–æ–∫—Å–æ–≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π, –µ—Å–ª–∏ –æ–Ω–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫:', error);
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã –Ω–∞—Å—Ç—Ä–æ–µ–∫
        document.getElementById('settings-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!userId) return;

            // –°–±–æ—Ä –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –±–∏—Ä–∂
            const selectedExchanges = Array.from(document.querySelectorAll('#exchange-checkboxes input:checked'))
                                         .map(cb => cb.dataset.exchange);

            // –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö –∏–∑ –ø–æ–ª–µ–π
            const blacklistText = document.getElementById('blacklist-input').value.trim();

            const settingsPayload = {
                user_id: parseInt(userId),
                exchanges: selectedExchanges,
                blacklist: [blacklistText],
                min_spread: parseFloat(document.getElementById('min-spread-input').value) || 3.0,
                min_funding_spread: parseFloat(document.getElementById('min-funding-spread-input').value) || 1.5,
                // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —á–∞—Å—Ç–æ—Ç—ã –∏ –≤–∫–ª—é—á–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
            };

            try {
                const response = await fetch('/api/save_settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(settingsPayload)
                });

                const result = await response.json();
                if (result.status === 'success') {
                    tg.showPopup({
                        message: '–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!',
                        title: '–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ',
                    });
                } else {
                    tg.showAlert(`–û—à–∏–±–∫–∞: ${result.message}`);
                }
            } catch (error) {
                tg.showAlert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
                console.error('Save error:', error);
            }
        });

        // ==================== –ù–∞—á–∞–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫ ====================
        document.addEventListener('DOMContentLoaded', () => {
            if (userId) {
                showScreen('trade'); // –ü–æ–∫–∞–∑–∞—Ç—å –≤–∫–ª–∞–¥–∫—É "–¢–æ—Ä–≥–æ–≤–ª—è" –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
            } else {
                screens.trade.innerHTML = '<div style="color:red;padding:20px;text-align:center;">–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å User ID. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞ —á–µ—Ä–µ–∑ –∫–æ–º–∞–Ω–¥—É /start.</div>';
            }
        });

    </script>
</body>
</html>